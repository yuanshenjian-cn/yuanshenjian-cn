---
title: 'OpenCode Agent 速查手册'
date: '2026-02-09'
tags:
  - 软件开发
  - AI 编程
  - OpenCode
published: true
brief: 'OpenCode 的 Sub Agent 功能让 AI 编程助手从单一对话模式升级为多代理协作系统。本文详细介绍 Primary Agent 与 Sub Agent 的区别、内置代理类型、配置方法以及实战使用技巧，帮助你构建更高效的 AI 辅助开发工作流。'
---

> OpenCode Sub Agent 让 AI 助手实现"分工协作"，复杂任务并行处理，效率倍增。

## 为什么需要 Sub Agent

使用传统 AI 编程助手时，所有任务都在同一个对话中完成。分析代码、修改文件、搜索文档——这些操作串行执行，效率受限。

OpenCode 的 Sub Agent 解决了这个问题：

- **并行处理**：多个任务同时执行
- **专业化分工**：不同代理负责不同领域
- **上下文隔离**：子任务不污染主对话
- **权限管控**：精细化控制每个代理的能力

## Agent 类型详解

OpenCode 有两种 Agent 类型：Primary（主代理）和 Sub（子代理）。

### Primary Agent（主代理）

直接与用户交互，处理主要对话。

| 代理 | 模式 | 特点 |
|------|------|------|
| **Build** | Primary | 默认代理，拥有全部工具权限 |
| **Plan** | Primary | 受限代理，仅分析和规划，不修改代码 |

**切换方式**：按 `Tab` 键循环切换。

### Sub Agent（子代理）

由主代理调用，处理特定任务。

| 代理 | 用途 |
|------|------|
| **General** | 通用任务，支持文件修改 |
| **Explore** | 代码库探索，只读模式 |

**调用方式**：`@agent-name` 手动调用，或由主代理自动调用。

### 系统代理

| 代理 | 模式 | 状态 | 功能 |
|------|------|------|------|
| **Compaction** | primary | 隐藏 | 自动压缩长上下文 |
| **Title** | primary | 隐藏 | 自动生成会话标题 |
| **Summary** | primary | 隐藏 | 自动创建会话摘要 |

## 内置代理使用指南

### Build 代理

全能型代理，适合日常开发。

**适用场景**：
- 编写和修改代码
- 执行系统命令
- 完整的开发任务

**特点**：所有工具默认启用。

### Plan 代理

安全分析型代理，适合代码审查。

**默认权限**：
- 文件编辑：需要确认（ask）
- Bash 命令：需要确认（ask）

**适用场景**：
- 代码审查
- 架构规划
- 方案设计

### General 子代理

通用任务处理专家。

```
@general 帮我并行处理以下任务：
1. 搜索所有使用了 fetch API 的文件
2. 分析 package.json 中的依赖
3. 列出 components 目录下的所有组件
```

**特点**：
- 完整工具访问（除 todo 外）
- 可修改文件
- 适合多任务并行

### Explore 子代理

代码库探索专家。

```
@explore 找出项目中所有自定义 Hook 的使用位置
```

**特点**：
- 只读模式，不会修改文件
- 快速搜索和定位
- 安全探索代码库

## 配置方法

### JSON 配置

在项目根目录创建 `opencode.json`：

```json
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "build": {
      "mode": "primary",
      "model": "anthropic/claude-sonnet-4-20250514",
      "tools": {
        "write": true,
        "edit": true,
        "bash": true
      }
    },
    "code-reviewer": {
      "description": "代码审查专家",
      "mode": "subagent",
      "model": "anthropic/claude-sonnet-4-20250514",
      "prompt": "专注于代码质量、安全性和性能优化",
      "tools": {
        "write": false,
        "edit": false
      }
    }
  }
}
```

### Markdown 配置

将代理配置文件保存为 `.md` 格式，支持两种保存位置：

- **全局配置**：`~/.config/opencode/agents/`（所有项目可用）
- **项目配置**：`.opencode/agents/`（当前项目专用）

例如，在全局目录创建 `review.md`：

```markdown
---
description: 代码审查专家
mode: subagent
model: anthropic/claude-sonnet-4-20250514
temperature: 0.1
tools:
  write: false
  edit: false
  bash: false
---

专注于：
- 代码质量和最佳实践
- 潜在 Bug 和边界情况
- 性能影响
- 安全考虑

仅提供建议，不做直接修改。
```

## 核心配置选项

### Temperature（温度）

控制输出的创造性和随机性。

| 范围 | 适用场景 |
|------|----------|
| 0.0-0.2 | 代码分析、规划（确定性高） |
| 0.3-0.5 | 一般开发任务（平衡） |
| 0.6-1.0 | 头脑风暴、探索（创造性高） |

> **默认值**：如果未指定温度，OpenCode 使用模型默认值（大多数模型为 0，Qwen 模型为 0.55）。

### Max Steps（最大步数）

限制代理的迭代次数，控制成本。

```json
{
  "agent": {
    "quick-thinker": {
      "steps": 5
    }
  }
}
```

### Permissions（权限）

精细控制工具权限。

```json
{
  "agent": {
    "review": {
      "permission": {
        "edit": "deny",
        "bash": {
          "*": "ask",
          "git status": "allow"
        }
      }
    }
  }
}
```

权限级别：
- `ask`：执行前询问
- `allow`：允许执行
- `deny`：禁止执行

### Mode（模式）

```json
{
  "agent": {
    "my-agent": {
      "mode": "subagent"  // primary | subagent | all
    }
  }
}
```

### Hidden（隐藏）

隐藏子代理，不让其在 `@` 菜单中显示。

```json
{
  "agent": {
    "internal-helper": {
      "mode": "subagent",
      "hidden": true
    }
  }
}
```

### Top P（采样控制）

控制响应多样性的温度替代方案。

```json
{
  "agent": {
    "brainstorm": {
      "top_p": 0.9
    }
  }
}
```

值范围 0.0-1.0：低值更聚焦，高值更多样。

### Color（颜色）

自定义代理在 UI 中的显示颜色。

支持十六进制颜色（如 `#FF5733`）或主题色：`primary`、`secondary`、`accent`、`success`、`warning`、`error`、`info`。

```json
{
  "agent": {
    "code-reviewer": {
      "color": "accent"
    },
    "creative": {
      "color": "#ff6b6b"
    }
  }
}
```

### Disable（禁用）

设置为 `true` 禁用代理。

```json
{
  "agent": {
    "review": {
      "disable": true
    }
  }
}
```

### Task Permission（代理调用权限）

控制代理可以调用哪些子代理，使用 glob 模式匹配。

```json
{
  "agent": {
    "orchestrator": {
      "mode": "primary",
      "permission": {
        "task": {
          "*": "deny",
          "orchestrator-*": "allow",
          "code-reviewer": "ask"
        }
      }
    }
  }
}
```

### Prompt（自定义提示）

指定自定义系统提示文件。

```json
{
  "agent": {
    "code-reviewer": {
      "prompt": "{file:./prompts/code-review.txt}"
    }
  }
}
```

路径相对于配置文件所在位置。

### Model（模型选择）

为不同代理使用不同模型。

```json
{
  "agent": {
    "plan": {
      "model": "anthropic/claude-haiku-4-20250514"
    },
    "build": {
      "model": "anthropic/claude-sonnet-4-20250514"
    }
  }
}
```

模型 ID 格式：`provider/model-id`。

### Other（传递给模型的参数）

其他选项会直接传递给模型提供商。

```json
{
  "agent": {
    "deep-thinker": {
      "description": "使用高推理努力解决复杂问题",
      "model": "openai/gpt-5",
      "reasoningEffort": "high"
    }
  }
}
```

## 实战技巧

### 手动调用子代理

```
@general 帮我分析这个函数的性能瓶颈
@explore 查找项目中所有未使用的导入
```

### 会话导航

当子代理创建子会话时：

- `<Leader>+Right`：向前切换（parent → child1 → child2）
- `<Leader>+Left`：向后切换（child2 → child1 → parent）

### 并行任务

让 General 子代理并行处理多个独立任务：

```
@general 同时执行：
1. 检查 src/utils/ 目录下所有文件
2. 分析 tests/ 目录的测试覆盖率
3. 搜索所有 TODO 注释
```

### 安全审查工作流

```
使用 Plan 代理分析代码 → 
@code-reviewer 审查安全风险 → 
Build 代理实施修改
```

## 自定义代理创建

使用命令行快速创建：

```bash
opencode agent create
```

交互式流程：
1. 选择保存位置（全局/项目）
2. 描述代理用途
3. 生成系统提示词
4. 选择可用工具
5. 创建 Markdown 配置文件

## 典型使用场景

| 场景 | 推荐代理 | 配置要点 |
|------|----------|----------|
| 日常开发 | Build | 全工具开启 |
| 代码审查 | Plan / 自定义 Review | 只读，温度 0.1-0.2 |
| 代码探索 | Explore | 只读 |
| 安全审计 | Security Auditor | 禁止写操作，温度 0.1 |
| 文档编写 | Docs Writer | 禁用 bash |
| 多任务并行 | General | 全工具 |
| 调试问题 | Debug | 禁止写操作，温度 0.2 |
| 创意探索 | Creative | 高温度 0.8，high top_p |
| 快速规划 | Plan (Haiku) | 使用 Haiku 模型节省成本 |

## 实用示例

### 代码审查代理配置示例

```markdown
---
description: 代码审查专家
mode: subagent
temperature: 0.1
tools:
  write: false
  edit: false
---

审查重点：
- 代码规范
- 潜在 Bug
- 性能问题
- 安全风险

提供建设性反馈。
```

### 安全审计代理配置示例

```markdown
---
description: 安全漏洞检测
mode: subagent
tools:
  write: false
  edit: false
---

关注：
- 输入验证漏洞
- 认证授权缺陷
- 数据暴露风险
- 依赖漏洞
```

### 文档编写代理配置示例

```markdown
---
description: 编写和维护项目文档
mode: subagent
model: anthropic/claude-sonnet-4-20250514
tools:
  bash: false
---

专注于：
- 清晰的解释
- 合理的结构
- 代码示例
- 友好的语言
```

### Debug 代理配置示例

```markdown
---
description: 调试专家
mode: subagent
model: anthropic/claude-sonnet-4-20250514
temperature: 0.2
tools:
  write: false
---

调试重点：
- 分析错误堆栈
- 追踪问题根因
- 提供修复建议
- 不直接修改代码
```

### 创意代理配置示例

```markdown
---
description: 创意头脑风暴
mode: subagent
model: anthropic/claude-sonnet-4-20250514
temperature: 0.8
top_p: 0.9
color: "#ff6b6b"
---

用于头脑风暴和创意探索，提供多种可能性。
```

## 实战工作流示例

### 完整的代码审查工作流

```
# 1. 使用 Plan 代理分析改动
<切换到 Plan 代理>
分析最近提交的更改，列出影响范围。

# 2. 使用 Explore 代理检查相关文件
@explore 找出所有被修改的文件及其依赖关系。

# 3. 使用自定义 review 代理进行审查
@review 审查这些更改，重点关注：
- 代码规范
- 潜在 Bug
- 性能影响
- 安全风险

# 4. 使用 Build 代理实施建议（如果需要）
<切换到 Build 代理>
根据 review 的建议修复发现的问题。
```

### 新功能开发工作流

```
# 1. Plan 模式制定方案
<切换到 Plan>
为用户添加「一键导出 PDF」功能，使用后端生成。

# 2. 探索现有代码
@explore 找出项目中现有的导出功能实现。

# 3. 并行任务处理
@general 同时完成：
1. 分析现有 PDF 生成库的兼容性
2. 设计 API 接口规范
3. 列出需要修改的组件清单

# 4. Build 模式实施
<切换到 Build>
根据 Plan 的方案开始实现。
```

### 性能优化工作流

```
# 1. 使用分析代理
<切换到 Plan>
分析项目性能瓶颈，提出优化方向。

# 2. 探索相关代码
@explore 找出所有数据库查询和 API 调用。

# 3. 并行分析
@general 并行处理：
1. 分析前端渲染性能
2. 分析 API 响应时间
3. 检查是否有未优化的查询

# 4. 实施优化
<切换到 Build>
根据分析结果实施性能优化。
```

### 安全审计工作流

```
# 1. 使用审计代理
@security-audit 对整个项目进行安全审计。

# 2. 深入检查特定模块
@explore 找出所有处理用户输入的代码。

# 3. 验证修复
@security-audit 验证最新提交的安全修复是否完整。
```

### 文档更新工作流

```
# 1. 使用 docs 代理
@docs 分析最近的代码更改，更新相关文档。

# 2. 探索文档结构
@explore 找出所有 API 文档和 README。

# 3. 并行更新
@docs 同时处理：
1. 更新 API 文档
2. 更新变更日志
3. 更新使用示例
```

### 调试复杂问题工作流

```
# 1. 使用 debug 代理
@debug 分析这个错误：[错误日志]

# 2. 探索相关代码
@explore 找出错误堆栈中涉及的所有文件。

# 3. 追踪调用链
@explore 追踪数据从入口到数据库的完整流向。

# 4. 提出修复方案
@debug 基于分析结果提供详细的修复建议。
```

## 高级技巧

### 使用通配符控制工具

禁用整个 MCP 服务器的工具：

```json
{
  "agent": {
    "readonly": {
      "tools": {
        "mymcp_*": false,
        "write": false,
        "edit": false
      }
    }
  }
}
```

### 精细化 Bash 命令权限

允许特定命令，其他都需要确认：

```json
{
  "agent": {
    "build": {
      "permission": {
        "bash": {
          "*": "ask",
          "git status": "allow",
          "git diff": "allow",
          "git log": "allow"
        }
      }
    }
  }
}
```

### 多代理协作配置

配置一个编排器代理控制子代理调用：

```json
{
  "agent": {
    "orchestrator": {
      "description": "任务编排器",
      "mode": "primary",
      "permission": {
        "task": {
          "*": "deny",
          "code-reviewer": "allow",
          "security-audit": "ask"
        }
      }
    },
    "code-reviewer": {
      "mode": "subagent",
      "tools": {
        "write": false,
        "edit": false
      }
    }
  }
}
```

### 不同场景的模型选择

```json
{
  "agent": {
    "plan": {
      "description": "快速规划",
      "mode": "primary",
      "model": "anthropic/claude-haiku-4-20250514",
      "temperature": 0.1
    },
    "build": {
      "description": "标准开发",
      "mode": "primary",
      "model": "anthropic/claude-sonnet-4-20250514",
      "temperature": 0.3
    },
    "creative": {
      "description": "创意探索",
      "mode": "subagent",
      "model": "anthropic/claude-opus-4-20250514",
      "temperature": 0.8,
      "top_p": 0.9
    }
  }
}
```

## 总结

OpenCode Agent 的核心价值：

1. **专业化分工**：不同任务交给不同专家
2. **并行处理**：多任务同时执行，节省时间
3. **权限隔离**：精细化控制，安全可控
4. **上下文管理**：主对话保持清晰

## 参考

- [官方文档 - 代理](https://opencode.ai/docs/agents/)
- [官方文档 - 介绍](https://opencode.ai/docs/)
- [GitHub](https://github.com/anomalyco/opencode)
- [社区](https://opencode.ai/discord)
