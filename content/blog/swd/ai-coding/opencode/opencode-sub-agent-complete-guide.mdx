---
title: 'OpenCode Sub Agent 完全指南：从手动调用到智能分派'
date: '2026-02-09'
tags:
  - 软件开发
  - AI 编程
  - OpenCode
published: false
brief: 'OpenCode 的 Sub Agent 功能让 AI 编程助手从单一对话模式升级为多代理协作系统。本文详细介绍 Primary Agent 与 Sub Agent 的区别、内置代理类型、配置方法以及实战使用技巧，帮助你构建更高效的 AI 辅助开发工作流。'
---

> OpenCode Sub Agent 让 AI 助手实现"分工协作"，复杂任务并行处理，效率倍增。

## 为什么需要 Sub Agent

使用传统 AI 编程助手时，所有任务都在同一个对话中完成。分析代码、修改文件、搜索文档——这些操作串行执行，效率受限。

OpenCode 的 Sub Agent 解决了这个问题：

- **并行处理**：多个任务同时执行
- **专业化分工**：不同代理负责不同领域
- **上下文隔离**：子任务不污染主对话
- **权限管控**：精细化控制每个代理的能力

## Agent 类型详解

OpenCode 有两种 Agent 类型：Primary（主代理）和 Sub（子代理）。

### Primary Agent（主代理）

直接与用户交互，处理主要对话。

| 代理 | 模式 | 特点 |
|------|------|------|
| **Build** | Primary | 默认代理，拥有全部工具权限 |
| **Plan** | Primary | 受限代理，仅分析和规划，不修改代码 |

**切换方式**：按 `Tab` 键循环切换。

### Sub Agent（子代理）

由主代理调用，处理特定任务。

| 代理 | 用途 |
|------|------|
| **General** | 通用任务，支持文件修改 |
| **Explore** | 代码库探索，只读模式 |

**调用方式**：`@agent-name` 手动调用，或由主代理自动调用。

### 系统代理

| 代理 | 功能 |
|------|------|
| **Compaction** | 自动压缩长上下文 |
| **Title** | 自动生成会话标题 |
| **Summary** | 自动创建会话摘要 |

## 内置代理使用指南

### Build 代理

全能型代理，适合日常开发。

**适用场景**：
- 编写和修改代码
- 执行系统命令
- 完整的开发任务

**特点**：所有工具默认启用。

### Plan 代理

安全分析型代理，适合代码审查。

**默认权限**：
- 文件编辑：需要确认（ask）
- Bash 命令：需要确认（ask）

**适用场景**：
- 代码审查
- 架构规划
- 方案设计

### General 子代理

通用任务处理专家。

```
@general 帮我并行处理以下任务：
1. 搜索所有使用了 fetch API 的文件
2. 分析 package.json 中的依赖
3. 列出 components 目录下的所有组件
```

**特点**：
- 完整工具访问（除 todo 外）
- 可修改文件
- 适合多任务并行

### Explore 子代理

代码库探索专家。

```
@explore 找出项目中所有自定义 Hook 的使用位置
```

**特点**：
- 只读模式，不会修改文件
- 快速搜索和定位
- 安全探索代码库

## 配置方法

### JSON 配置

在项目根目录创建 `opencode.json`：

```json
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "build": {
      "mode": "primary",
      "model": "anthropic/claude-sonnet-4-20250514",
      "tools": {
        "write": true,
        "edit": true,
        "bash": true
      }
    },
    "code-reviewer": {
      "description": "代码审查专家",
      "mode": "subagent",
      "model": "anthropic/claude-sonnet-4-20250514",
      "prompt": "专注于代码质量、安全性和性能优化",
      "tools": {
        "write": false,
        "edit": false
      }
    }
  }
}
```

### Markdown 配置

在 `~/.config/opencode/agents/` 创建 `review.md`：

```markdown
---
description: 代码审查专家
mode: subagent
model: anthropic/claude-sonnet-4-20250514
temperature: 0.1
tools:
  write: false
  edit: false
  bash: false
---

专注于：
- 代码质量和最佳实践
- 潜在 Bug 和边界情况
- 性能影响
- 安全考虑

仅提供建议，不做直接修改。
```

## 核心配置选项

### Temperature（温度）

控制输出的创造性和随机性。

| 范围 | 适用场景 |
|------|----------|
| 0.0-0.2 | 代码分析、规划（确定性高） |
| 0.3-0.5 | 一般开发任务（平衡） |
| 0.6-1.0 | 头脑风暴、探索（创造性高） |

### Max Steps（最大步数）

限制代理的迭代次数，控制成本。

```json
{
  "agent": {
    "quick-thinker": {
      "steps": 5
    }
  }
}
```

### Permissions（权限）

精细控制工具权限。

```json
{
  "agent": {
    "review": {
      "permission": {
        "edit": "deny",
        "bash": {
          "*": "ask",
          "git status": "allow"
        }
      }
    }
  }
}
```

权限级别：
- `ask`：执行前询问
- `allow`：允许执行
- `deny`：禁止执行

### Mode（模式）

```json
{
  "agent": {
    "my-agent": {
      "mode": "subagent"  // primary | subagent | all
    }
  }
}
```

### Hidden（隐藏）

隐藏子代理，不让其在 `@` 菜单中显示。

```json
{
  "agent": {
    "internal-helper": {
      "mode": "subagent",
      "hidden": true
    }
  }
}
```

## 实战技巧

### 手动调用子代理

```
@general 帮我分析这个函数的性能瓶颈
@explore 查找项目中所有未使用的导入
```

### 会话导航

当子代理创建子会话时：

- `<Leader>+Right`：向前切换（parent → child1 → child2）
- `<Leader>+Left`：向后切换（child2 → child1 → parent）

### 并行任务

让 General 子代理并行处理多个独立任务：

```
@general 同时执行：
1. 检查 src/utils/ 目录下所有文件
2. 分析 tests/ 目录的测试覆盖率
3. 搜索所有 TODO 注释
```

### 安全审查工作流

```
使用 Plan 代理分析代码 → 
@code-reviewer 审查安全风险 → 
Build 代理实施修改
```

## 自定义代理创建

使用命令行快速创建：

```bash
opencode agent create
```

交互式流程：
1. 选择保存位置（全局/项目）
2. 描述代理用途
3. 生成系统提示词
4. 选择可用工具
5. 创建 Markdown 配置文件

## 典型使用场景

| 场景 | 推荐代理 | 配置要点 |
|------|----------|----------|
| 日常开发 | Build | 全开 |
| 代码审查 | Plan / Review | 只读 |
| 代码探索 | Explore | 只读 |
| 安全审计 | Security Auditor | 禁止写操作 |
| 文档编写 | Docs Writer | 禁用 bash |
| 多任务并行 | General | 全工具 |

## 实用示例

### 代码审查代理配置示例

```markdown
---
description: 代码审查专家
mode: subagent
temperature: 0.1
tools:
  write: false
  edit: false
---

审查重点：
- 代码规范
- 潜在 Bug
- 性能问题
- 安全风险

提供建设性反馈。
```

### 安全审计代理配置示例

```markdown
---
description: 安全漏洞检测
mode: subagent
tools:
  write: false
  edit: false
---

关注：
- 输入验证漏洞
- 认证授权缺陷
- 数据暴露风险
- 依赖漏洞
```

## 总结

OpenCode Sub Agent 的核心价值：

1. **专业化分工**：不同任务交给不同专家
2. **并行处理**：多任务同时执行，节省时间
3. **权限隔离**：精细化控制，安全可控
4. **上下文管理**：主对话保持清晰

> 开始使用：安装 OpenCode，按 `Tab` 切换代理，输入 `@` 调用子代理。

| 资源 | 链接 |
|------|------|
| 官方文档 | https://opencode.ai/docs/agents/ |
| GitHub | https://github.com/anomalyco/opencode |
| 社区 | https://opencode.ai/discord |
