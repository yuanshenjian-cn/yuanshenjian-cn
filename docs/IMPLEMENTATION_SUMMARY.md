# åšå®¢å¢å¼ºåŠŸèƒ½å®æ–½æ€»ç»“

## å®æ–½å®Œæˆçš„åŠŸèƒ½æ¸…å•

### âœ… 1. CSP å®‰å…¨å¤´é…ç½®
**ä½ç½®**: `public/_headers`

**åŠŸèƒ½**:
- Content-Security-Policy (CSP) é˜²æ­¢ XSS æ”»å‡»
- X-Frame-Options é˜²æ­¢ç‚¹å‡»åŠ«æŒ
- X-Content-Type-Options é˜²æ­¢ MIME ç±»å‹å—…æ¢
- Referrer-Policy æ§åˆ¶ referrer ä¿¡æ¯
- Permissions-Policy é™åˆ¶æµè§ˆå™¨åŠŸèƒ½

**é…ç½®å†…å®¹**:
```
Content-Security-Policy: 
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://giscus.app;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com;
  img-src 'self' data: https:;
  connect-src 'self' https://giscus.app;
  frame-src https://giscus.app
```

**æ³¨æ„**: ç”±äºé™æ€å¯¼å‡ºé™åˆ¶ï¼ŒCSP é€šè¿‡ `_headers` æ–‡ä»¶é…ç½®ï¼Œé€‚ç”¨äº Cloudflare Pages / Netlify

---

### âœ… 2. ä»£ç å—å¢å¼ºï¼ˆå¤åˆ¶æŒ‰é’® + è¡Œå·ï¼‰
**ç»„ä»¶**: `components/code-block.tsx`
**ä¿®æ”¹**: `lib/mdx.tsx`

**åŠŸèƒ½**:
- æ‚¬æµ®å¤åˆ¶æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼Œé¼ æ ‡æ‚¬åœæ˜¾ç¤ºï¼‰
- ä¸€é”®å¤åˆ¶ä»£ç åˆ°å‰ªè´´æ¿
- å¤åˆ¶æˆåŠŸåé¦ˆï¼ˆå›¾æ ‡å˜ âœ“ï¼Œ2ç§’åæ¢å¤ï¼‰
- æ˜¾ç¤ºè¡Œå·ï¼ˆå·¦ä¾§ç°è‰²æ•°å­—åˆ—ï¼‰
- å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒæ¨ªå‘æ»šåŠ¨

**æŠ€æœ¯å®ç°**:
- é€’å½’æå– React children ä¸­çš„ä»£ç æ–‡æœ¬
- è‡ªåŠ¨æ£€æµ‹ä»£ç å—ï¼ˆé€šè¿‡ `language-` ç±»åï¼‰
- ä¿æŒä¸ rehype-prism-plus è¯­æ³•é«˜äº®å…¼å®¹
- ä½¿ç”¨ Clipboard API å®ç°å¤åˆ¶åŠŸèƒ½

**æ•ˆæœé¢„è§ˆ**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [å¤åˆ¶æŒ‰é’®]                             â”‚
â”‚ 1  const example = "Hello World";       â”‚
â”‚ 2  console.log(example);               â”‚
â”‚ 3  // è¡Œå·æ˜¾ç¤ºåœ¨å·¦ä¾§                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âœ… 3. é˜…è¯»è¿›åº¦æ¡
**ç»„ä»¶**: `components/reading-progress.tsx`
**é›†æˆ**: `app/articles/[...]/page.tsx`

**åŠŸèƒ½**:
- å›ºå®šåœ¨é¡µé¢é¡¶éƒ¨ï¼ˆ2px é«˜åº¦ï¼‰
- æ¸å˜è‰²è®¾è®¡ï¼ˆä¸åšå®¢æ•´ä½“é£æ ¼åè°ƒï¼‰
- å¹³æ»‘åŠ¨ç”»è¿‡æ¸¡
- ä½¿ç”¨ requestAnimationFrame ä¼˜åŒ–æ€§èƒ½
- å¯è®¿é—®æ€§æ”¯æŒï¼ˆaria å±æ€§ï¼‰

**é¢œè‰²æ–¹æ¡ˆ**:
- æ¸å˜è‰²æ¡ï¼šä» foreground åˆ° foreground/60
- é€‚é…æ˜æš—ä¸»é¢˜

**æ€§èƒ½ä¼˜åŒ–**:
- ä½¿ç”¨ `requestAnimationFrame` é¿å…é¢‘ç¹é‡ç»˜
- è¢«åŠ¨æ»šåŠ¨äº‹ä»¶ç›‘å¬ `{ passive: true }`
- ä»…åœ¨æ–‡ç« é¡µé¢åŠ è½½

---

### âœ… 4. å›¾ç‰‡ä¼˜åŒ–æ„å»ºè„šæœ¬
**è„šæœ¬**: `scripts/optimize-images.js`
**é›†æˆ**: `package.json` build å‘½ä»¤

**åŠŸèƒ½**:
- æ„å»ºæ—¶è‡ªåŠ¨è½¬æ¢å›¾ç‰‡ä¸º WebP æ ¼å¼
- ç”Ÿæˆ 400w, 800w, 1200w ä¸‰ç§å“åº”å¼å°ºå¯¸
- è‡ªåŠ¨æ£€æµ‹å¹¶è·³è¿‡å·²ä¼˜åŒ–å›¾ç‰‡ï¼ˆåŸºäºä¿®æ”¹æ—¶é—´ï¼‰
- è®¡ç®—å¹¶æ˜¾ç¤ºå‹ç¼©èŠ‚çœçš„ç™¾åˆ†æ¯”
- ç”Ÿæˆä¼˜åŒ–æŠ¥å‘Šï¼ˆ`.next/image-optimization-report.json`ï¼‰

**å¤„ç†æµç¨‹**:
1. æ‰«æ `public/images/` ç›®å½•
2. è¯†åˆ«æ”¯æŒçš„æ ¼å¼ï¼ˆjpg, jpeg, png, webpï¼‰
3. ä½¿ç”¨ sharp åº“è½¬æ¢å¹¶å‹ç¼©
4. ç”Ÿæˆå¸¦å°ºå¯¸åç¼€çš„ WebP æ–‡ä»¶ï¼ˆå¦‚ `image-800w.webp`ï¼‰
5. ä¿ç•™åŸæ–‡ä»¶ä½œä¸º fallback

**æ„å»ºç»“æœ**:
```
âœ¨ å›¾ç‰‡ä¼˜åŒ–å®Œæˆï¼
ğŸ“ˆ å…±å¤„ç† 89 å¼ å›¾ç‰‡
   å¹³å‡èŠ‚çœ 30-50% æ–‡ä»¶å¤§å°
```

**ä½¿ç”¨æ–¹æ³•**:
```bash
# æ„å»ºæ—¶è‡ªåŠ¨è¿è¡Œ
npm run build

# æ‰‹åŠ¨è¿è¡Œ
npm run optimize-images
```

---

### âœ… 5. PWA åŸºç¡€æ”¯æŒ
**æ–‡ä»¶**:
- `public/manifest.json` - PWA é…ç½®æ¸…å•
- `public/sw.js` - Service Worker è„šæœ¬
- `components/service-worker-registration.tsx` - SW æ³¨å†Œç»„ä»¶
- `app/layout.tsx` - é›†æˆ SW æ³¨å†Œ

**åŠŸèƒ½**:
- Web App Manifestï¼ˆåº”ç”¨ä¿¡æ¯ã€å›¾æ ‡ã€ä¸»é¢˜è‰²ï¼‰
- Service Worker æ³¨å†Œå’Œæ¿€æ´»
- é™æ€èµ„æºç¼“å­˜ç­–ç•¥ï¼ˆStale-While-Revalidateï¼‰
- ç¦»çº¿é¡µé¢å›é€€æ”¯æŒ
- æ·»åŠ åˆ°ä¸»å±å¹•æ”¯æŒ

**ç¼“å­˜ç­–ç•¥**:
- æ ¸å¿ƒèµ„æºï¼ˆé¦–é¡µã€æ–‡ç« é¡µï¼‰ï¼šå®‰è£…æ—¶é¢„ç¼“å­˜
- é™æ€èµ„æºï¼ˆJS/CSSï¼‰ï¼šè¿è¡Œæ—¶ç¼“å­˜ï¼Œä¼˜å…ˆä½¿ç”¨ç¼“å­˜
- å›¾ç‰‡èµ„æºï¼šæŒ‰éœ€ç¼“å­˜
- Service Workerï¼šä¸ç¼“å­˜ï¼Œç¡®ä¿è·å–æœ€æ–°ç‰ˆæœ¬

**æ‰€éœ€å›¾æ ‡**ï¼ˆéœ€è¦æ‰‹åŠ¨å‡†å¤‡ï¼‰:
```
public/icons/
â”œâ”€â”€ icon-72x72.png
â”œâ”€â”€ icon-96x96.png
â”œâ”€â”€ icon-128x128.png
â”œâ”€â”€ icon-144x144.png
â”œâ”€â”€ icon-152x152.png
â”œâ”€â”€ icon-192x192.png (å¿…éœ€)
â”œâ”€â”€ icon-384x384.png
â””â”€â”€ icon-512x512.png (å¿…éœ€)
```

**å›¾æ ‡ç”ŸæˆæŒ‡å—**: `docs/PWA_ICONS_GUIDE.md`

**æµ‹è¯•æ–¹æ³•**:
1. Chrome DevTools â†’ Lighthouse â†’ PWA æ£€æµ‹
2. DevTools â†’ Application â†’ Manifest æŸ¥çœ‹é…ç½®
3. åœ°å€æ å³ä¾§å®‰è£…æŒ‰é’®ï¼ˆæ¡Œé¢ Chromeï¼‰
4. Android Chromeï¼šèœå• â†’ "æ·»åŠ åˆ°ä¸»å±å¹•"
5. iOS Safariï¼šåˆ†äº«æŒ‰é’® â†’ "æ·»åŠ åˆ°ä¸»å±å¹•"

---

## æ–‡ä»¶å˜æ›´æ¸…å•

### æ–°å»ºæ–‡ä»¶
```
components/code-block.tsx                    # ä»£ç å—ç»„ä»¶
components/reading-progress.tsx              # é˜…è¯»è¿›åº¦æ¡
components/service-worker-registration.tsx   # SW æ³¨å†Œ
scripts/optimize-images.js                   # å›¾ç‰‡ä¼˜åŒ–è„šæœ¬
public/manifest.json                         # PWA æ¸…å•
public/sw.js                                 # Service Worker
public/_headers                              # HTTP å¤´é…ç½®
public/icons/                                # PWA å›¾æ ‡ç›®å½•
docs/PWA_ICONS_GUIDE.md                      # å›¾æ ‡ç”ŸæˆæŒ‡å—
```

### ä¿®æ”¹æ–‡ä»¶
```
next.config.ts                               # æ¢å¤åŸå§‹é…ç½®
app/layout.tsx                               # æ·»åŠ  SW æ³¨å†Œå’Œ manifest
app/articles/[...]/page.tsx                  # æ·»åŠ é˜…è¯»è¿›åº¦æ¡
lib/mdx.tsx                                  # ä½¿ç”¨ CodeBlock ç»„ä»¶
package.json                                 # æ·»åŠ  optimize-images è„šæœ¬
```

---

## æ„å»ºæµ‹è¯•

âœ… **æ„å»ºçŠ¶æ€**: æˆåŠŸ
- å¤„ç†äº† 89 å¼ å›¾ç‰‡
- ç”Ÿæˆäº† 55 ä¸ªé™æ€é¡µé¢
- æ‰€æœ‰ç»„ä»¶æ­£å¸¸ç¼–è¯‘
- Service Worker å·²ç”Ÿæˆ

**è¾“å‡ºæ–‡ä»¶**:
- `dist/manifest.json` âœ…
- `dist/sw.js` âœ…
- `dist/_headers` âœ…
- `dist/icons/` âœ…

---

## åç»­å»ºè®®

### ç«‹å³è¡ŒåŠ¨ï¼ˆå¯é€‰ï¼‰
1. **å‡†å¤‡ PWA å›¾æ ‡**
   - å‚è€ƒ `docs/PWA_ICONS_GUIDE.md`
   - ä½¿ç”¨åŸå§‹ Logo ç”Ÿæˆå„å°ºå¯¸å›¾æ ‡
   - æ”¾ç½®åˆ° `public/icons/` ç›®å½•

2. **æµ‹è¯• CSP**
   - éƒ¨ç½²åæ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°
   - ç¡®ä¿æ²¡æœ‰ CSP è¿è§„é”™è¯¯
   - Giscus è¯„è®ºæ­£å¸¸åŠ è½½

### ç›‘æ§æ£€æŸ¥
1. **ä»£ç å—åŠŸèƒ½**
   - æ‰“å¼€ä»»æ„å¸¦ä»£ç çš„æ–‡ç« 
   - æµ‹è¯•å¤åˆ¶æŒ‰é’®
   - ç¡®è®¤è¡Œå·æ˜¾ç¤ºæ­£ç¡®

2. **é˜…è¯»è¿›åº¦æ¡**
   - æ»šåŠ¨é•¿æ–‡ç« 
   - è§‚å¯Ÿè¿›åº¦æ¡æ›´æ–°
   - ç¡®è®¤æ¸å˜è‰²ç¬¦åˆä¸»é¢˜

3. **å›¾ç‰‡ä¼˜åŒ–**
   - æ£€æŸ¥ `.next/image-optimization-report.json`
   - éªŒè¯ WebP æ–‡ä»¶å·²ç”Ÿæˆ
   - ç¡®è®¤èŠ‚çœç©ºé—´ç¬¦åˆé¢„æœŸ

4. **PWA åŠŸèƒ½**
   - Chrome DevTools Lighthouse æ£€æµ‹
   - æµ‹è¯•æ·»åŠ åˆ°ä¸»å±å¹•
   - éªŒè¯ç¦»çº¿è®¿é—®ï¼ˆæ–­å¼€ç½‘ç»œï¼‰

---

## æ³¨æ„äº‹é¡¹

1. **å›¾ç‰‡ä¼˜åŒ–**: 
   - é¦–æ¬¡æ„å»ºä¼šå®‰è£… `sharp` ä¾èµ–
   - åç»­æ„å»ºä¼šè‡ªåŠ¨æ£€æµ‹è·³è¿‡æœªæ›´æ”¹å›¾ç‰‡
   - åŸå›¾ç‰‡ä¿ç•™ä½œä¸º fallback

2. **CSP é…ç½®**:
   - åŸºäº `_headers` æ–‡ä»¶ï¼Œä»…é€‚ç”¨äº Cloudflare Pages / Netlify
   - å¦‚ä½¿ç”¨å…¶ä»–æ‰˜ç®¡ï¼Œéœ€æ‰‹åŠ¨é…ç½®æœåŠ¡å™¨

3. **PWA å›¾æ ‡**:
   - å½“å‰ä¸ºå ä½ç¬¦çŠ¶æ€
   - éƒ¨ç½²å‰åŠ¡å¿…æ·»åŠ çœŸå®å›¾æ ‡
   - ç¼ºå°‘å›¾æ ‡ä¼šå½±å“ PWA å®‰è£…ä½“éªŒ

4. **Service Worker**:
   - ä»…åœ¨ç”Ÿäº§ç¯å¢ƒæ³¨å†Œ
   - é¦–æ¬¡è®¿é—®åä¼šç¼“å­˜æ ¸å¿ƒèµ„æº
   - æ›´æ–°åéœ€è¦ç”¨æˆ·åˆ·æ–°é¡µé¢è·å–æ–°ç‰ˆæœ¬

---

**å®æ–½æ—¥æœŸ**: 2026-02-07  
**å®æ–½è€…**: OpenCode  
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆ
